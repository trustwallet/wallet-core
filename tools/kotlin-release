#!/bin/bash

set -e

source $(dirname $0)/library
version=$(wc_read_version $1)

echo "Building $version"

export ANDROID_HOME="$HOME/Library/Android/sdk"
export BOOST_ROOT=$(brew --prefix boost)

pushd kotlin
./gradlew :wallet-core-kotlin:generateProtos
./gradlew :wallet-core-kotlin:assemble -Pversion="$version"

echo "Publishing to Maven Local..."
./gradlew :wallet-core-kotlin:publishAllPublicationsToMavenLocalRepository -Pversion="$version"

echo ""
echo "Published artifacts in Maven Local (~/.m2/repository/com/trustwallet):"
find ~/.m2/repository/com/trustwallet -type f -name "*.pom" -o -name "*.jar" -o -name "*.aar" -o -name "*.klib" 2>/dev/null | grep "$version" | sort || echo "No artifacts found"

echo "Publishing to GitHub Packages..."
./gradlew :wallet-core-kotlin:publishAllPublicationsToGitHubPackagesRepository -Pversion="$version" || echo "Warning: GitHub Packages publishing failed"

popd

echo "Kotlin build uploaded"
