// SPDX-License-Identifier: Apache-2.0
//
// Copyright Â© 2017 Trust Wallet.

#include "HexCoding.h"
#include "TestUtilities.h"
#include <TrustWalletCore/Generated/TWEthereum.h>
#include <TrustWalletCore/Generated/TWBizPasskeySession.h>
#include "proto/BizPasskeySession.pb.h"
#include "uint256.h"

#include <PrivateKey.h>

namespace TW::BizPasskeySession::tests {

TEST(BizPasskeySession, RegisterSession) {
    const PublicKey& publicKey = PublicKey(parse_hex("0x041c05286fe694493eae33312f2d2e0d0abeda8db76238b7a204be1fb87f54ce4228fef61ef4ac300f631657635c28e59bfb2fe71bce1634c81c65642042f6dc4d"), TWPublicKeyTypeNIST256p1Extended);

    const auto validUntil = store(uint256_t(86401));
    const auto publicKeyPtr = WRAP(TWPublicKey, new TWPublicKey{ TW::PublicKey(publicKey) });
    const auto validUntilPtr = WRAPD(TWDataCreateWithBytes(validUntil.data(), validUntil.size()));
    const auto& result = TWBizPasskeySessionEncodeRegisterSessionCall(
        publicKeyPtr.get(),
        validUntilPtr.get()
    );
    const auto& encoded = hexEncoded(*reinterpret_cast<const Data*>(WRAPD(result).get()));

    ASSERT_EQ(encoded, "0x826491fb000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000151810000000000000000000000000000000000000000000000000000000000000041041c05286fe694493eae33312f2d2e0d0abeda8db76238b7a204be1fb87f54ce4228fef61ef4ac300f631657635c28e59bfb2fe71bce1634c81c65642042f6dc4d00000000000000000000000000000000000000000000000000000000000000");
}

TEST(BizPasskeySession, RemoveSessionFFI) {
    const PublicKey& publicKey = PublicKey(parse_hex("0x041c05286fe694493eae33312f2d2e0d0abeda8db76238b7a204be1fb87f54ce4228fef61ef4ac300f631657635c28e59bfb2fe71bce1634c81c65642042f6dc4d"), TWPublicKeyTypeNIST256p1Extended);

    const auto publicKeyPtr = WRAP(TWPublicKey, new TWPublicKey{ TW::PublicKey(publicKey) });
    const auto& result = TWBizPasskeySessionEncodeRemoveSessionCall(publicKeyPtr.get());
    const auto& encoded = hexEncoded(*reinterpret_cast<const Data*>(WRAPD(result).get()));

    ASSERT_EQ(encoded, "0xe1c06abd00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000041041c05286fe694493eae33312f2d2e0d0abeda8db76238b7a204be1fb87f54ce4228fef61ef4ac300f631657635c28e59bfb2fe71bce1634c81c65642042f6dc4d00000000000000000000000000000000000000000000000000000000000000");
}

TEST(BizPasskeySession, EncodePasskeyNonce) {
    auto nonce = store(uint256_t(123));
    const auto& result = TWBizPasskeySessionEncodePasskeySessionNonce(
        WRAPD(TWDataCreateWithBytes(nonce.data(), nonce.size())).get()
    );
    const auto& encoded = hexEncoded(*reinterpret_cast<const Data*>(WRAPD(result).get()));

    ASSERT_EQ(encoded, "0x00000000000000000000000000000000050041d6a66939a8000000000000007b");
}

TEST(BizPasskeySession, ExecuteWithPasskeySession) {
    const uint64_t ONE_ETH = 1000000000000000000ULL;

    TW::BizPasskeySession::Proto::ExecuteWithPasskeySessionInput input;

    // Add three executions
    auto* execution1 = input.add_executions();
    execution1->set_address("0x0000000000000000000000000000000000000001");
    auto amount1 = store(uint256_t(ONE_ETH));
    execution1->set_amount(amount1.data(), amount1.size());
    // Empty payload

    auto* execution2 = input.add_executions();
    execution2->set_address("0x0000000000000000000000000000000000000002");
    auto amount2 = store(uint256_t(ONE_ETH));
    execution2->set_amount(amount2.data(), amount2.size());
    // Empty payload

    auto* execution3 = input.add_executions();
    execution3->set_address("0x0000000000000000000000000000000000000003");
    auto amount3 = store(uint256_t(ONE_ETH));
    execution3->set_amount(amount3.data(), amount3.size());
    // Empty payload

    input.set_valid_after(0);
    input.set_valid_until(61);

    auto passkeySignature = parse_hex("0x00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000017000000000000000000000000000000000000000000000000000000000000000188458d3b608d1195be386bc6017e389d46624b50cb450792fb8c91e84e3e1ff912aabc684a855da9e83cb6cafe74950dcf6d81e8b3b2b7a5437abc1762ca736d000000000000000000000000000000000000000000000000000000000000002549960de5880e8c687434170f6476605b8fe4aeb9a28632c7995cf3ba831d97630500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008a7b2274797065223a22776562617574686e2e676574222c226368616c6c656e6765223a22343368697353614c5553757a6547785330662d705443686731736334616873307949645f7162463141634d222c226f726967696e223a2268747470733a2f2f7369676e2e636f696e626173652e636f6d222c2263726f73734f726967696e223a66616c73657d00000000000000000000000000000000000000000000");
    input.set_passkey_signature(passkeySignature.data(), passkeySignature.size());

    const auto& serialized = input.SerializeAsString();
    const auto& encodedCall = TWBizPasskeySessionEncodeExecuteWithPasskeySessionCall(
        WRAPD(TWDataCreateWithBytes((const uint8_t *)serialized.data(), serialized.size())).get()
    );
    const auto& encodedCallData = hexEncoded(*reinterpret_cast<const Data*>(WRAPD(encodedCall).get()));

    ASSERT_EQ(encodedCallData, "0x38892f8800000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000003d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000de0b6b3a76400000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000de0b6b3a76400000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020100000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000017000000000000000000000000000000000000000000000000000000000000000188458d3b608d1195be386bc6017e389d46624b50cb450792fb8c91e84e3e1ff912aabc684a855da9e83cb6cafe74950dcf6d81e8b3b2b7a5437abc1762ca736d000000000000000000000000000000000000000000000000000000000000002549960de5880e8c687434170f6476605b8fe4aeb9a28632c7995cf3ba831d97630500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008a7b2274797065223a22776562617574686e2e676574222c226368616c6c656e6765223a22343368697353614c5553757a6547785330662d705443686731736334616873307949645f7162463141634d222c226f726967696e223a2268747470733a2f2f7369676e2e636f696e626173652e636f6d222c2263726f73734f726967696e223a66616c73657d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
}

TEST(BizPasskeySession, ExecuteWithSignature) {
    TW::BizPasskeySession::Proto::ExecuteWithSignatureInput input;

    // Set up execution - IERC20(TWT).approve()
    auto* execution = input.add_executions();
    execution->set_address("0x4B0F1812e5Df2A09796481Ff14017e6005508003");
    execution->set_amount(parse_hex("0x00").data(), 0); // 0 amount
    // ERC20 approve(spender: 0xBC472b43BC237f733c78a581078F58A6a89c46Ec, allowance: 12345)
    auto approvePayload = parse_hex("0x095ea7b3000000000000000000000000bc472b43bc237f733c78a581078f58a6a89c46ec0000000000000000000000000000000000000000000000000000000000003039");
    execution->set_payload(approvePayload.data(), approvePayload.size());

    // Set private key
    auto privateKey = parse_hex("0xefec50f00ef0c09d967f3e363ee96502ce18a1881f6ac22321aa58071d43c66f");
    input.set_private_key(privateKey.data(), privateKey.size());

    // Set nonce (0)
    input.set_nonce(parse_hex("0x00").data(), 0);

    // Set valid_after and valid_until
    input.set_valid_after(1766601881);
    input.set_valid_until(1766605881);

    // Set encoding hash params
    auto* encodingHashParams = input.mutable_encoding_hash_params();
    auto chainId = parse_hex("0x38"); // 56
    encodingHashParams->set_chain_id(chainId.data(), chainId.size());
    encodingHashParams->set_code_address("0x02C8740f2C040Fd7A0d21E839796bCf8317d5Ca5");
    encodingHashParams->set_code_name("PasskeySession");
    encodingHashParams->set_code_version("v1.0.0");
    encodingHashParams->set_type_hash("0xb652cbbd5eeff31f202f0ace5b19b61f379c8232b83129e309719b4c1321d038");
    encodingHashParams->set_domain_separator_hash("0xd87cd6ef79d4e2b95e15ce8abf732db51ec771f1ca2edccf22a46c729ac56472");

    const auto& serialized = input.SerializeAsString();
    const auto& encodedCall = TWBizPasskeySessionSignExecuteWithSignatureCall(
        WRAPD(TWDataCreateWithBytes((const uint8_t *)serialized.data(), serialized.size())).get()
    );
    const auto& encodedCallData = hexEncoded(*reinterpret_cast<const Data*>(WRAPD(encodedCall).get()));

    // Successfully broadcasted tx:
    // https://bscscan.com/tx/0xf93520101e1cc890cf3e58cc870f2b59906d0890d35ded39c0552beec619f6a0
    ASSERT_EQ(encodedCallData, "0x3b0f8c1d0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000694c4439000000000000000000000000694c34990000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000004b0f1812e5df2a09796481ff14017e6005508003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044095ea7b3000000000000000000000000bc472b43bc237f733c78a581078f58a6a89c46ec000000000000000000000000000000000000000000000000000000000000303900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004175a7828e4411403210baefbce2a1dde4dc8c88dc6655bbc0e4bd06d510ba1b6f5ca3f630400d7ccc49bc8aeda9a81dd4b85a911470a4acf07a4a28b2fc294d051c00000000000000000000000000000000000000000000000000000000000000");
}

} // namespace TW::BizPasskeySession::tests

