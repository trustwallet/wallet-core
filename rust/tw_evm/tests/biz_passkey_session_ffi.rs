// SPDX-License-Identifier: Apache-2.0
//
// Copyright Â© 2017 Trust Wallet.

use std::str::FromStr;
use tw_encoding::hex::{DecodeHex, ToHex};
use tw_evm::abi::prebuild::erc20::Erc20;
use tw_evm::address::Address;
use tw_evm::ffi::biz_passkey_session::{
    tw_biz_passkey_session_encode_execute_with_passkey_session_call,
    tw_biz_passkey_session_encode_passkey_session_nonce,
    tw_biz_passkey_session_encode_register_session_call,
    tw_biz_passkey_session_encode_remove_session_call,
    tw_biz_passkey_session_sign_execute_with_signature_call,
};
use tw_keypair::test_utils::tw_public_key_helper::TWPublicKeyHelper;
use tw_keypair::tw::PublicKeyType;
use tw_memory::test_utils::tw_data_helper::TWDataHelper;
use tw_number::U256;
use tw_proto::serialize;
use tw_proto::BizPasskeySession::Proto::{
    EncodingHashParams, ExecuteWithPasskeySessionInput, ExecuteWithSignatureInput, Execution,
};

const ONE_ETH: u64 = 1_000_000_000_000_000_000;

#[test]
fn test_register_session_ffi() {
    let public_key = TWPublicKeyHelper::with_hex(
        "0x041c05286fe694493eae33312f2d2e0d0abeda8db76238b7a204be1fb87f54ce4228fef61ef4ac300f631657635c28e59bfb2fe71bce1634c81c65642042f6dc4d",
        PublicKeyType::Nist256p1Extended
    );
    let valid_until = TWDataHelper::create(U256::from(86_401_u64).to_big_endian_compact());
    let data = TWDataHelper::wrap(unsafe {
        tw_biz_passkey_session_encode_register_session_call(public_key.ptr(), valid_until.ptr())
    });
    assert_eq!(
        data.to_vec().unwrap().to_hex(),
        "826491fb000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000151810000000000000000000000000000000000000000000000000000000000000041041c05286fe694493eae33312f2d2e0d0abeda8db76238b7a204be1fb87f54ce4228fef61ef4ac300f631657635c28e59bfb2fe71bce1634c81c65642042f6dc4d00000000000000000000000000000000000000000000000000000000000000"
    );
}

#[test]
fn test_remove_session_ffi() {
    let public_key = TWPublicKeyHelper::with_hex(
        "0x041c05286fe694493eae33312f2d2e0d0abeda8db76238b7a204be1fb87f54ce4228fef61ef4ac300f631657635c28e59bfb2fe71bce1634c81c65642042f6dc4d",
        PublicKeyType::Nist256p1Extended
    );
    let data = TWDataHelper::wrap(unsafe {
        tw_biz_passkey_session_encode_remove_session_call(public_key.ptr())
    });
    assert_eq!(
        data.to_vec().unwrap().to_hex(),
        "e1c06abd00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000041041c05286fe694493eae33312f2d2e0d0abeda8db76238b7a204be1fb87f54ce4228fef61ef4ac300f631657635c28e59bfb2fe71bce1634c81c65642042f6dc4d00000000000000000000000000000000000000000000000000000000000000"
    );
}

#[test]
fn test_encode_passkey_nonce_ffi() {
    let nonce = TWDataHelper::create(U256::from(123_u64).to_big_endian_compact());
    let data = TWDataHelper::wrap(unsafe {
        tw_biz_passkey_session_encode_passkey_session_nonce(nonce.ptr())
    });
    assert_eq!(
        data.to_vec().unwrap().to_hex(),
        "00000000000000000000000000000000050041d6a66939a8000000000000007b"
    );
}

#[test]
fn test_execute_with_passkey_session_ffi() {
    let passkey_signature = "0x00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000017000000000000000000000000000000000000000000000000000000000000000188458d3b608d1195be386bc6017e389d46624b50cb450792fb8c91e84e3e1ff912aabc684a855da9e83cb6cafe74950dcf6d81e8b3b2b7a5437abc1762ca736d000000000000000000000000000000000000000000000000000000000000002549960de5880e8c687434170f6476605b8fe4aeb9a28632c7995cf3ba831d97630500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008a7b2274797065223a22776562617574686e2e676574222c226368616c6c656e6765223a22343368697353614c5553757a6547785330662d705443686731736334616873307949645f7162463141634d222c226f726967696e223a2268747470733a2f2f7369676e2e636f696e626173652e636f6d222c2263726f73734f726967696e223a66616c73657d00000000000000000000000000000000000000000000";
    let input = ExecuteWithPasskeySessionInput {
        executions: vec![
            Execution {
                address: "0x0000000000000000000000000000000000000001".into(),
                amount: U256::from(ONE_ETH).to_big_endian_compact().into(),
                payload: Default::default(),
            },
            Execution {
                address: "0x0000000000000000000000000000000000000002".into(),
                amount: U256::from(ONE_ETH).to_big_endian_compact().into(),
                payload: Default::default(),
            },
            Execution {
                address: "0x0000000000000000000000000000000000000003".into(),
                amount: U256::from(ONE_ETH).to_big_endian_compact().into(),
                payload: Default::default(),
            },
        ],
        valid_after: 0,
        valid_until: 61,
        passkey_signature: passkey_signature.decode_hex().unwrap().into(),
    };
    let input = TWDataHelper::create(serialize(&input).unwrap());

    let encoded = TWDataHelper::wrap(unsafe {
        tw_biz_passkey_session_encode_execute_with_passkey_session_call(input.ptr())
    });
    let expected = "0x38892f8800000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000003d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000de0b6b3a76400000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000de0b6b3a76400000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020100000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000017000000000000000000000000000000000000000000000000000000000000000188458d3b608d1195be386bc6017e389d46624b50cb450792fb8c91e84e3e1ff912aabc684a855da9e83cb6cafe74950dcf6d81e8b3b2b7a5437abc1762ca736d000000000000000000000000000000000000000000000000000000000000002549960de5880e8c687434170f6476605b8fe4aeb9a28632c7995cf3ba831d97630500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008a7b2274797065223a22776562617574686e2e676574222c226368616c6c656e6765223a22343368697353614c5553757a6547785330662d705443686731736334616873307949645f7162463141634d222c226f726967696e223a2268747470733a2f2f7369676e2e636f696e626173652e636f6d222c2263726f73734f726967696e223a66616c73657d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
    assert_eq!(encoded.to_vec().unwrap().to_hex_prefixed(), expected);
}

#[test]
fn test_execute_with_signature_ffi() {
    let spender = Address::from_str("0xBC472b43BC237f733c78a581078F58A6a89c46Ec").unwrap();
    let allowance = U256::from(12345_u64);
    // 0xeAff4df45C35c6d80aDc2E353F8Fc5b93613ef2b
    let private_key = "0xefec50f00ef0c09d967f3e363ee96502ce18a1881f6ac22321aa58071d43c66f";
    let nonce = U256::encode_be_compact(0);

    let chain_id = U256::encode_be_compact(56);
    let biz_passkey_session_address = "0x02C8740f2C040Fd7A0d21E839796bCf8317d5Ca5";
    let biz_passkey_session_code_name = "PasskeySession";
    let biz_passkey_session_code_version = "v1.0.0";
    // keccak("PasskeySession(bytes32 execHash)")
    let type_hash = "0xb652cbbd5eeff31f202f0ace5b19b61f379c8232b83129e309719b4c1321d038";
    // keccak("EIP712Domain(string name,string version,uint256 chainId,address verifyingContract,bytes32 salt)")
    let biz_passkey_session_domain_separator_hash =
        "0xd87cd6ef79d4e2b95e15ce8abf732db51ec771f1ca2edccf22a46c729ac56472";

    let input = ExecuteWithSignatureInput {
        executions: vec![
            // IERC20(TWT).approve()
            Execution {
                address: "0x4B0F1812e5Df2A09796481Ff14017e6005508003".into(),
                amount: U256::encode_be_compact(0),
                payload: Erc20::approve(spender, allowance).unwrap().into(),
            },
        ],
        private_key: private_key.decode_hex().unwrap().into(),
        nonce,
        valid_after: 1_766_601_881_u64,
        valid_until: 1_766_605_881_u64,
        encoding_hash_params: Some(EncodingHashParams {
            chain_id,
            code_address: biz_passkey_session_address.into(),
            code_name: biz_passkey_session_code_name.into(),
            code_version: biz_passkey_session_code_version.into(),
            type_hash: type_hash.into(),
            domain_separator_hash: biz_passkey_session_domain_separator_hash.into(),
        }),
    };
    let input = TWDataHelper::create(serialize(&input).unwrap());

    let encoded = TWDataHelper::wrap(unsafe {
        tw_biz_passkey_session_sign_execute_with_signature_call(input.ptr())
    });

    // Successfully broadcasted tx:
    // https://bscscan.com/tx/0xf93520101e1cc890cf3e58cc870f2b59906d0890d35ded39c0552beec619f6a0
    let expected = "0x3b0f8c1d0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000694c4439000000000000000000000000694c34990000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000004b0f1812e5df2a09796481ff14017e6005508003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044095ea7b3000000000000000000000000bc472b43bc237f733c78a581078f58a6a89c46ec000000000000000000000000000000000000000000000000000000000000303900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004175a7828e4411403210baefbce2a1dde4dc8c88dc6655bbc0e4bd06d510ba1b6f5ca3f630400d7ccc49bc8aeda9a81dd4b85a911470a4acf07a4a28b2fc294d051c00000000000000000000000000000000000000000000000000000000000000";
    assert_eq!(encoded.to_vec().unwrap().to_hex_prefixed(), expected);
}
