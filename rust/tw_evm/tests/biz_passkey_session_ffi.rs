// SPDX-License-Identifier: Apache-2.0
//
// Copyright Â© 2017 Trust Wallet.

use tw_encoding::hex::{DecodeHex, ToHex};
use tw_evm::ffi::biz_passkey_session::{
    tw_biz_encode_execute_with_passkey_session_call, tw_biz_encode_passkey_session_nonce,
    tw_biz_encode_register_session_call, tw_biz_encode_remove_session_call,
};
use tw_keypair::test_utils::tw_public_key_helper::TWPublicKeyHelper;
use tw_keypair::tw::PublicKeyType;
use tw_memory::test_utils::tw_data_helper::TWDataHelper;
use tw_number::U256;
use tw_proto::serialize;
use tw_proto::Biz::Proto::{ExecuteWithPasskeySessionInput, Execution};

const ONE_ETH: u64 = 1_000_000_000_000_000_000;

#[test]
fn test_register_session_ffi() {
    let public_key = TWPublicKeyHelper::with_hex(
        "0x041c05286fe694493eae33312f2d2e0d0abeda8db76238b7a204be1fb87f54ce4228fef61ef4ac300f631657635c28e59bfb2fe71bce1634c81c65642042f6dc4d",
        PublicKeyType::Nist256p1Extended
    );
    let valid_until = TWDataHelper::create(U256::from(86_401_u64).to_big_endian_compact());
    let data = TWDataHelper::wrap(unsafe {
        tw_biz_encode_register_session_call(public_key.ptr(), valid_until.ptr())
    });
    assert_eq!(
        data.to_vec().unwrap().to_hex(),
        "826491fb000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000151810000000000000000000000000000000000000000000000000000000000000041041c05286fe694493eae33312f2d2e0d0abeda8db76238b7a204be1fb87f54ce4228fef61ef4ac300f631657635c28e59bfb2fe71bce1634c81c65642042f6dc4d00000000000000000000000000000000000000000000000000000000000000"
    );
}

#[test]
fn test_remove_session_ffi() {
    let public_key = TWPublicKeyHelper::with_hex(
        "0x041c05286fe694493eae33312f2d2e0d0abeda8db76238b7a204be1fb87f54ce4228fef61ef4ac300f631657635c28e59bfb2fe71bce1634c81c65642042f6dc4d",
        PublicKeyType::Nist256p1Extended
    );
    let data = TWDataHelper::wrap(unsafe { tw_biz_encode_remove_session_call(public_key.ptr()) });
    assert_eq!(
        data.to_vec().unwrap().to_hex(),
        "e1c06abd00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000041041c05286fe694493eae33312f2d2e0d0abeda8db76238b7a204be1fb87f54ce4228fef61ef4ac300f631657635c28e59bfb2fe71bce1634c81c65642042f6dc4d00000000000000000000000000000000000000000000000000000000000000"
    );
}

#[test]
fn test_encode_passkey_nonce_ffi() {
    let nonce = TWDataHelper::create(U256::from(123_u64).to_big_endian_compact());
    let data = TWDataHelper::wrap(unsafe { tw_biz_encode_passkey_session_nonce(nonce.ptr()) });
    assert_eq!(
        data.to_vec().unwrap().to_hex(),
        "00000000000000000000000000000000050041d6a66939a8000000000000007b"
    );
}

#[test]
fn test_execute_with_passkey_session_ffi() {
    let passkey_signature = "0x00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000017000000000000000000000000000000000000000000000000000000000000000188458d3b608d1195be386bc6017e389d46624b50cb450792fb8c91e84e3e1ff912aabc684a855da9e83cb6cafe74950dcf6d81e8b3b2b7a5437abc1762ca736d000000000000000000000000000000000000000000000000000000000000002549960de5880e8c687434170f6476605b8fe4aeb9a28632c7995cf3ba831d97630500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008a7b2274797065223a22776562617574686e2e676574222c226368616c6c656e6765223a22343368697353614c5553757a6547785330662d705443686731736334616873307949645f7162463141634d222c226f726967696e223a2268747470733a2f2f7369676e2e636f696e626173652e636f6d222c2263726f73734f726967696e223a66616c73657d00000000000000000000000000000000000000000000";
    let input = ExecuteWithPasskeySessionInput {
        executions: vec![
            Execution {
                address: "0x0000000000000000000000000000000000000001".into(),
                amount: U256::from(ONE_ETH).to_big_endian_compact().into(),
                payload: Default::default(),
            },
            Execution {
                address: "0x0000000000000000000000000000000000000002".into(),
                amount: U256::from(ONE_ETH).to_big_endian_compact().into(),
                payload: Default::default(),
            },
            Execution {
                address: "0x0000000000000000000000000000000000000003".into(),
                amount: U256::from(ONE_ETH).to_big_endian_compact().into(),
                payload: Default::default(),
            },
        ],
        valid_after: 0,
        valid_until: 61,
        passkey_signature: passkey_signature.decode_hex().unwrap().into(),
    };
    let input = TWDataHelper::create(serialize(&input).unwrap());

    let encoded =
        TWDataHelper::wrap(unsafe { tw_biz_encode_execute_with_passkey_session_call(input.ptr()) });
    let expected = "0x38892f8800000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000003d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000de0b6b3a76400000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000de0b6b3a76400000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020100000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000017000000000000000000000000000000000000000000000000000000000000000188458d3b608d1195be386bc6017e389d46624b50cb450792fb8c91e84e3e1ff912aabc684a855da9e83cb6cafe74950dcf6d81e8b3b2b7a5437abc1762ca736d000000000000000000000000000000000000000000000000000000000000002549960de5880e8c687434170f6476605b8fe4aeb9a28632c7995cf3ba831d97630500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008a7b2274797065223a22776562617574686e2e676574222c226368616c6c656e6765223a22343368697353614c5553757a6547785330662d705443686731736334616873307949645f7162463141634d222c226f726967696e223a2268747470733a2f2f7369676e2e636f696e626173652e636f6d222c2263726f73734f726967696e223a66616c73657d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
    assert_eq!(encoded.to_vec().unwrap().to_hex_prefixed(), expected);
}
