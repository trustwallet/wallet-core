<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Core WASM Demo</title>
</head>
<body>
<h1>Wallet Core WASM Demo</h1>
<div class="emscripten">
    <progress value="0" max="100" id="progress" hidden=1></progress>
</div>
<div class="emscripten_border">
    <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex=-1></canvas>
</div>
<div style="margin: 20px 0; padding: 10px; background: #f5f5f5; border-radius: 5px;">
    <label style="margin-right: 20px;">
        <input type="checkbox" id="overrideRandomValues" value="unchecked">
        Override getRandomValues function
    </label>
    <button id="runScript" disabled style="padding: 10px 20px; cursor: pointer; margin-right: 10px;">
        Generate Private Key
    </button>
    <button id="runStoredKey" disabled style="padding: 10px 20px; cursor: pointer; margin-right: 10px;">
        Generate StoredKey
    </button>
    <button id="runProtobuf" disabled style="padding: 10px 20px; cursor: pointer;">
        Run Protobuf Tests
    </button>
</div>
<div id="output"></div>
<script type="text/javascript" src="./wallet-core.js"></script>
<script type="text/javascript"
        src="https://cdn.jsdelivr.net/gh/dcodeIO/protobuf.js@6.11.3/dist/minimal/protobuf.js"></script>
<script type="text/javascript" src="./core_proto.js"></script>
<script>
    // Function to print parameters on screen as separate entries
    function print(...args) {
        const output = document.getElementById('output');
        const entry = document.createElement('div');
        entry.style.marginBottom = '5px';
        entry.style.padding = '5px';
        entry.style.borderBottom = '1px solid #eee';

        const message = args.map(arg =>
            typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
        ).join(' ');

        entry.textContent = message;
        output.appendChild(entry);
        output.scrollTop = output.scrollHeight; // Auto-scroll to bottom
    }

    // Store the original function
    const originalGetRandomValues = window.crypto.getRandomValues.bind(window.crypto);
    let isOverrideEnabled = false;

    // Create the override wrapper
    window.crypto.getRandomValues = function(array) {
        if (isOverrideEnabled) {
            print('crypto.getRandomValues called with:', {
                type: array.constructor.name,
                length: array.length,
                byteLength: array.byteLength,
            });
        }
        return originalGetRandomValues(array);
    };

    // Initialize the WASM module
    (async () => {
        print("<== TW wasm module has been loaded...");

        // Module() returns a promise that resolves to the WalletCore instance
        const WalletCore = await Module();

        // Now you can access PrivateKey and other classes
        const { PrivateKey, HexCoding, CoinType, Curve, StoredKey } = WalletCore;

        // Function to run the key generation script
        function runKeyGeneration() {
            print("==> Starting key generation...");
            const privateKey = PrivateKey.create(Curve.secp256k1);
            const privateKeyData = privateKey.data();
            print("Generated private key (hex):", HexCoding.encode(privateKeyData));
            // Clean up
            privateKey.delete();
        }

        function runStoredKeyGeneration() {
            const password = new TextEncoder().encode("My password");

            print("==> Starting StoredKey generation...");
            const storedKey = StoredKey.create("My wallet", password);
            const wallet = storedKey.wallet(password);
            const account = storedKey.accountForCoin(CoinType.ethereum, wallet);
            const privateKey = storedKey.privateKey(CoinType.ethereum, password);
            print("Generated Ethereum address: ", account.address());
            print("Generated Ethereum private key (hex):", HexCoding.encode(privateKey.data()));

            // Clean up
            privateKey.delete();
            account.delete();
            wallet.delete();
            storedKey.delete();
        }

        // Function to run Protobuf tests
        function runProtobufTests() {
            print("==> Starting Protobuf tests...");
            var TW = window.protobuf.roots.default.TW;

            // Test 1: Ethereum SigningInput
            var ethInput = TW.Ethereum.Proto.SigningInput.create({
                toAddress: "0x6b175474e89094c44da98b954eedeac495271d0f",
                txMode: TW.Ethereum.Proto.TransactionMode.Enveloped,
                transaction: TW.Ethereum.Proto.Transaction.create({
                    erc20Transfer: TW.Ethereum.Proto.Transaction.ERC20Transfer.create({
                        to: "0x5322b34c88ed0691971bf52a7047448f0f4efc84",
                    }),
                })
            });
            print("Ethereum.SigningInput:", JSON.stringify(ethInput.toJSON(), null, 2));

            // Test 2: Bitcoin SigningInput
            try {
                var btcInput = TW.Bitcoin.Proto.SigningInput.create({
                    hashType: 1,
                    amount: "100000000",
                    byteFee: "1",
                    toAddress: "1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa",
                });
                print("Bitcoin.SigningInput:", JSON.stringify(btcInput.toJSON(), null, 2));
            } catch (e) {
                print("Bitcoin test skipped:", e.message);
            }

            print("==> Protobuf tests complete!");
        }

        // Set up checkbox event listener
        const checkbox = document.getElementById('overrideRandomValues');
        checkbox.addEventListener('change', function() {
            isOverrideEnabled = this.checked;
            print(`==> getRandomValues override ${isOverrideEnabled ? 'enabled' : 'disabled'}`);
        });

        // Set up button event listener
        const button = document.getElementById('runScript');
        button.disabled = false;
        button.addEventListener('click', runKeyGeneration);

        // Set up stored key button event listener
        const storedKeyButton = document.getElementById('runStoredKey');
        storedKeyButton.disabled = false;
        storedKeyButton.addEventListener('click', runStoredKeyGeneration);

        // Set up protobuf button event listener
        const protobufButton = document.getElementById('runProtobuf');
        protobufButton.disabled = false;
        protobufButton.addEventListener('click', runProtobufTests);

        print("==> Ready! Click the buttons to run tests.");
    })();
</script>
</body>
</html>
